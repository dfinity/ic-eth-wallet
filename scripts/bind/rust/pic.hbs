//! Bindings to the `{{ canister_name }}` canister, generated by `./scripts/bind/rust.sh`
//!
//! Binding configuration: `./scripts/bind/rust/{{ canister_name }}.pic.toml`
//! 
//! Adapted from: <https://github.com/dfinity/candid/blob/master/rust/candid_parser/src/bindings/rust_call.hbs>
#![allow(dead_code, unused_imports, clippy::all, clippy::missing_errors_doc)]
use std::sync::Arc;

use candid::{self, CandidType, Deserialize, Principal, decode_args, encode_args};
use pocket_ic::{PocketIc, WasmResult};

pub use ic_{{snake_case canister_name}}_types::*;

{{#if submodule}}
pub mod {{submodule}};
{{/if}}

{{#if methods}}
pub struct {{PascalCase canister_name}}Pic {
    pub pic: Arc<PocketIc>,
    pub canister_id: Principal,
}

impl {{PascalCase canister_name}}Pic {
  {{#each methods}}
  pub fn {{this.name}}(&self, caller: Principal{{#each this.args}}, {{this.0}}: &{{this.1}}{{/each}}) -> Result<({{#each this.rets}}{{this}}, {{/each}}), String> {
        let args = encode_args(({{#each this.args}}{{this.0}}, {{/each}})).expect("Failed to encode update call arguments");
        self.pic
            .update_call(self.canister_id, caller, "create_canister", args)
            .map_err(|e| {
                format!(
                    "Update call error. RejectionCode: {:?}, Error: {}",
                    e.code, e.description
                )
            })
            .and_then(|reply| match reply {
                WasmResult::Reply(reply) => {
                    decode_args(&reply).map_err(|e| format!("Decoding failed: {e}"))
                }
                WasmResult::Reject(error) => Err(error),
            })
  }
  {{/each}}
}
{{#if canister_id}}
pub const CANISTER_ID : Principal = Principal::from_slice(&[{{principal_slice canister_id}}]); // {{canister_id}}
{{/if}}
{{/if}}
{{#if tests}}
{{tests}}
{{/if}}
